head	1.1;
access;
symbols;
locks; strict;
comment	@# @;


1.1
date	2020.10.19.16.14.18;	author williamp;	state Exp;
branches;
next	;


desc
@A stub Makefile to bootstrap the project
@


1.1
log
@Initial revision
@
text
@# A stub Makefile used to bootstrap.

srcdir := $(dir $(abspath $(lastword $(MAKEFILE_LIST))))
BUILDDIR := $(srcdir)/build/$(shell uname -s)/$(shell uname -m)

.PHONY: all check clean dist distclean install loc release
all: $(BUILDDIR) $(BUILDDIR)/Makefile
	cd $(BUILDDIR) && make all

release: $(BUILDDIR)
	-cd $(BUILDDIR) && make distclean
	make all
	cd $(BUILDDIR) && make version && make distcheck

configure:
	autoreconf -ivf

$(BUILDDIR)/Makefile: configure
	cd $(BUILDDIR) && $(srcdir)/configure CFLAGS="${CFLAGS} --coverage -g -O0"

$(BUILDDIR):
	mkdir -p $(BUILDDIR)

loc:
	@@cd $(BUILDDIR) && \
	for file in action handler smtx-main vtparser; do \
		gcov $${file}.c -o .libs; \
	done | tr "':" ' '| awk ' \
		/^File/ {file=$$2; gsub(".*/", "", file)} \
		/Lines executed/{printf "%32s:\t%s\t(%s)\n", file, $$5, $$3; t+= $$5} \
		END{printf "%32s:\t%s\n", "Total", t}'

install: $(BUILDDIR) $(BUILDDIR)/Makefile
	cd $(BUILDDIR) && make install

check: $(BUILDDIR) $(BUILDDIR)/Makefile
	cd $(BUILDDIR) && make check

clean: $(BUILDDIR) $(BUILDDIR)/Makefile
	cd $(BUILDDIR) && make clean

dist: $(BUILDDIR) $(BUILDDIR)/Makefile
	cd $(BUILDDIR) && make version && make dist

distclean: $(BUILDDIR) $(BUILDDIR)/Makefile
	cd $(BUILDDIR) && make distclean
@
